# Incidente: Confirmación de compra devuelve 404

**Timestamp (local):** 2026-02-18 23:45

## Resumen del síntoma
- UI (`/carrito`) mostraba toast: **"No se pudo confirmar la compra – Not Found"**.
- Request fallido reportado: `POST http://localhost:9500/api/carrito/confirmar`.
- Contexto: API Gateway en `9500`, frontend en `5173`.

## Evidencia

### 1) Tabla de rutas del gateway (pre-fix)
Comando:
```bash
curl -i http://localhost:9500/actuator/gateway/routes/ventas-carrito
```
Resultado relevante:
```json
{
  "route_id":"ventas-carrito",
  "predicate":"... Paths: [/api/carrito/**] ...",
  "filters":["[[StripPrefix parts = 1], order = 1]"],
  "uri":"http://ventas-service:8083"
}
```

### 2) Logs del gateway (pre-fix)
Se observó que `POST /api/carrito/confirmar` matcheaba `ventas-carrito` y se reenviaba como `/carrito/confirmar` por `StripPrefix=1`.

Snippet:
```text
Route matched: ventas-carrito
Mapping [Exchange: POST http://localhost:9500/api/carrito/confirmar] ...
gatewayFilters=[[[StripPrefix parts = 1], order = 1]]
ObservedRequest ... http.uri='http://localhost:9500/carrito/confirmar'
```

### 3) Logs de ventas-service (pre-fix)
Snippet:
```text
{POST [/api/carrito/confirmar]}: confirmarCompra(ConfirmarCompraRequest)
Writing [{timestamp=..., status=404, error=Not Found, path=/carrito/confirmar}]
```
Esto prueba mismatch de path entre gateway y backend.

### 4) Rutas activas del gateway (post-fix)
Comandos:
```bash
curl -i http://localhost:9500/actuator/gateway/routes/ventas-carrito-confirmar
curl -i http://localhost:9500/actuator/gateway/routes/ventas-compras
```
Resultados relevantes:
```json
{
  "route_id":"ventas-carrito-confirmar",
  "predicate":"... Paths: [/api/carrito/confirmar] ...",
  "filters":[],
  "uri":"http://ventas-service:8083"
}
```
```json
{
  "route_id":"ventas-compras",
  "predicate":"... Paths: [/api/compras/**] ...",
  "filters":[],
  "uri":"http://ventas-service:8083"
}
```

### 5) Validación funcional post-fix
Comando:
```bash
curl -i -X POST http://localhost:9500/api/carrito/confirmar \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d "{}"
```
Resultado:
```http
HTTP/1.1 201 Created
Location: /api/compras/1
```
Body relevante:
```json
{"compraId":1,"totalFinal":19000.99,"estado":"CONFIRMADA"}
```

También:
```bash
curl -i http://localhost:9500/api/compras -H "Authorization: Bearer <token>"
```
Respuesta `200 OK` con compra listada.

## Análisis de causa raíz
La causa raíz fue un **mismatch de ruteo en API Gateway**:
- El backend de ventas expone confirmación en `POST /api/carrito/confirmar` (controlador `CompraController` con `@RequestMapping("/api")`).
- La ruta gateway `/api/carrito/**` tenía `StripPrefix=1`, por lo que `POST /api/carrito/confirmar` se reenviaba a `/carrito/confirmar`.
- Ese path no existe en ventas para confirmación, produciendo `404 Not Found`.

## Fix implementado
1. Se agregaron rutas específicas **sin StripPrefix** para endpoints de compras:
   - `ventas-carrito-confirmar`: `Path=/api/carrito/confirmar`
   - `ventas-compras`: `Path=/api/compras/**`
2. Se mantuvo la ruta genérica `ventas-carrito` con `StripPrefix=1` para operaciones legacy de carrito (`/api/carrito/items`, etc.).
3. Se agregó prueba de regresión para proteger configuración de rutas.

**No Docker changes were made.**

## Archivos modificados
- `src/main/resources/application-docker.yml`
- `src/main/resources/application.yml`
- `pom.xml`
- `src/test/java/com/videoclub/apigateway/GatewayRoutesRegressionTest.java`

## Validación (comandos + resultados)
```bash
# Tests de regresión en gateway
mvn -q test
# Resultado: OK

# Reconstrucción y arranque del gateway con compose full
docker compose -f docker-compose-full.yml up -d --build api-gateway
# Resultado: api-gateway Started

# Verificación rutas
curl -i http://localhost:9500/actuator/gateway/routes/ventas-carrito-confirmar
curl -i http://localhost:9500/actuator/gateway/routes/ventas-compras
# Resultado: ambas 200 y sin StripPrefix

# Flujo confirmar compra
curl -X POST http://localhost:9090/realms/videoclub/protocol/openid-connect/token ...
curl -i -X POST http://localhost:9500/api/carrito/confirmar -H "Authorization: Bearer <token>" -H "Content-Type: application/json" -d "{}"
# Resultado: 201 Created

curl -i http://localhost:9500/api/compras -H "Authorization: Bearer <token>"
# Resultado: 200 OK
```

## Tests agregados/actualizados
- `GatewayRoutesRegressionTest.routeVentasCarritoConfirmar_mantienePrefijoApi`
  - Verifica que `/api/carrito/confirmar` tenga ruta dedicada sin `StripPrefix`.
- `GatewayRoutesRegressionTest.routeVentasCompras_mantienePrefijoApi`
  - Verifica que `/api/compras/**` tenga ruta dedicada sin `StripPrefix`.

## Riesgos y follow-ups
- Si se agregan nuevos endpoints bajo `/api` en ventas, deben evaluarse rutas específicas antes de aplicar `StripPrefix` genérico.
- Recomendación: mantener convenciones homogéneas de prefijos (`/api`) entre gateway y microservicios para evitar regresiones.
