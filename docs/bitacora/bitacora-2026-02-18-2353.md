# Incidente: GET /api/compras/{id} devuelve 401 Unauthorized

## 1. Timestamp (local)

- 2026-02-18 23:53

## 2. Síntoma observado

- Frontend en `/compras/3` reporta `HTTP 401 Unauthorized` al consultar `GET http://localhost:9500/api/compras/3`.
- Reproducción técnica equivalente:
  - `curl -i http://localhost:9500/api/compras/3`
  - Resultado: `HTTP/1.1 401 Unauthorized`.

## 3. Evidencia recolectada

### 3.1 Network request headers

- Request (sin token):
  - `GET /api/compras/3`
  - **Authorization header: ausente**
- Response headers (401):
  - `WWW-Authenticate: Bearer resource_metadata="http://ventas-service:8083/.well-known/oauth-protected-resource"`
  - `Set-Cookie: JSESSIONID=...`
  - `Content-Length: 0`

### 3.2 Token payload (decoded)

Token obtenido desde Keycloak para validar JWT:

- Endpoint: `POST http://localhost:9090/realms/videoclub/protocol/openid-connect/token`
- Grant: `password`
- Cliente: `admin-cli`
- Usuario: `usuariocliente`

Claims decodificados relevantes:

- `iss`: `http://localhost:9090/realms/videoclub`
- `exp`: `2026-02-19 02:58:26Z`
- `now`: `2026-02-19 02:53:27Z` (token vigente)
- `preferred_username`: `usuariocliente`
- `scope`: `email profile`
- `aud`: no presente en access token observado
- `realm_access.roles`: no presente en access token observado
- `resource_access`: no presente en access token observado

### 3.3 Gateway route evidence

- `GET http://localhost:9500/actuator/gateway/routes` muestra ruta activa:
  - `route_id: ventas-compras`
  - `predicate: Path=/api/compras/**`
  - `uri: http://ventas-service:8083`
  - `filters: []` (sin `StripPrefix`)
- Configuración de seguridad en gateway:
  - `/api/carrito/**` autenticado
  - `/api/compras/**` cae en `.anyExchange().permitAll()`
- Filtro global de relay:
  - `TokenRelayGlobalFilter` agrega `Authorization` downstream cuando hay `JwtAuthenticationToken` en contexto.

### 3.4 Backend security logs

- Gateway (con JWT malformado):
  - `Authentication failed: ... InvalidBearerTokenException ... Invalid unsecured/JWS/JWE header`
  - Confirma que gateway intenta decodificar cuando llega un bearer inválido.
- Ventas:
  - No se observó traza de rechazo detallada en `tail` consultado (predominan health checks), pero la respuesta de 401 sin token incluye `WWW-Authenticate` apuntando a `ventas-service`.

### 3.5 Pruebas comparativas de flujo

- Con token válido por gateway:
  - `curl -i -H "Authorization: Bearer <token_valido>" http://localhost:9500/api/compras/3`
  - Resultado: `404 COMPRA_NO_ENCONTRADA` (no 401).
- Con token válido directo a ventas:
  - `curl -i -H "Authorization: Bearer <token_valido>" http://localhost:8083/api/compras/3`
  - Resultado: `404 COMPRA_NO_ENCONTRADA` (idéntico al gateway).
- Sin token por gateway:
  - `401 Unauthorized`.

## 4. Hipótesis consideradas

1. Falta header Authorization desde frontend.
2. JWT vencido o malformado.
3. Gateway no reenvía Authorization.
4. ventas-service rechaza por configuración de Resource Server.
5. Mismatch de roles/authorities (`ROLE_` prefix).
6. Configuración incorrecta del cliente en Keycloak.

## 5. Validaciones realizadas

- Header en request fallida: **sin Authorization**.
- JWT válido: `iss` correcto, `exp` vigente.
- Gateway enruta correctamente `/api/compras/**` a ventas.
- ventas-service está como Resource Server (`spring.security.oauth2.resourceserver.jwt.*` presente).
- `/api/**` en ventas requiere autenticación en perfil productivo-like; no exige rol específico en esta ruta.
- No se detecta restricción por `ROLE_`/converter para `/api/compras/{id}` (solo `authenticated()`).
- Con token válido, endpoint pasa autenticación (respuesta de negocio 404), lo cual descarta fallo de forwarding o de JWT para este caso.

## 6. Causa raíz identificada (if determinable)

**Causa raíz identificada:** falta de Bearer token en la request del frontend hacia `/api/compras/{id}`.

Evidencia de código frontend:

- `CompraDetalle.jsx` y `Compras.jsx` consumen `const { token } = useAuth();`
- `AuthContext` no expone propiedad `token` en el `value` del contexto.
- `ventas.js` solo agrega `Authorization` si `token` existe (`buildHeaders`).

Resultado neto:

- Request sale sin `Authorization` → ventas-service responde `401 Unauthorized`.

## 7. Riesgos detectados

- Cualquier endpoint autenticado consumido desde frontend puede fallar en cascada por ausencia de token.
- Dificulta diagnóstico porque gateway permite `/api/compras/**` y el 401 aparece downstream.
- Posible confusión por diferencias entre entornos (token malformado falla en gateway, token ausente falla en ventas).

## 8. Próximos pasos recomendados (analysis-only, no fixes applied)

1. Verificar en DevTools del navegador la request real de `/api/compras/3` para confirmar ausencia de `Authorization` en sesión UI.
2. Confirmar contrato del `AuthContext` con las páginas consumidoras (`token` disponible en contexto antes de disparar fetch).
3. Añadir trazas de diagnóstico en frontend para loggear presencia de token (sin imprimirlo completo).
4. Mantener prueba comparativa por curl (con y sin token) como smoke test de autenticación de compras.
5. Revisar explícitamente requerimiento funcional: historial de compras requiere usuario autenticado y sesión activa en frontend.

_No Docker changes were made._
