# Puerto en el que se ejecuta el API Gateway
server:
  port: 9500
  # Si quieres habilitar HTTPS, agrega aquí la configuración SSL

logging:
  level:
    root: INFO # Nivel de log global
    org.springframework.web: INFO # Nivel de log para Spring Web
    org.springframework.cloud.gateway: DEBUG # Nivel de log para Spring Cloud Gateway (temporal)
    reactor.netty.http.client: DEBUG # HTTP client debug for forwarded requests
    org.springframework.security: DEBUG # Para debug de seguridad
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %logger{36} - %msg%n" # Formato de salida en consola

spring:
  application.name: api-gateway # Nombre de la aplicación

  # Configuración de OAuth2 Resource Server (JWT con Keycloak)
  security:
    oauth2:
      resourceserver:
        jwt:
          #issuer-uri: http://keycloak-sso:8080/realms/videoclub
          # Mantenemos el nombre que viene EN el token (el que pediste desde afuera)
          issuer-uri: http://localhost:9090/realms/videoclub
          # Pero le decimos al Gateway dónde buscar las llaves REALMENTE (red interna)
          jwk-set-uri: http://keycloak-sso:8080/realms/videoclub/protocol/openid-connect/certs

  cloud:
    gateway:
      # CORS is now handled by CorsWebFilterConfig bean (applies to ALL responses)
      # globalcors disabled to prevent duplicate CORS headers
      routes:
        - id: catalogo # Servicio de Catálogo de Películas
          uri: http://catalogo-backend:8081 # Puerto del servicio Catálogo
          predicates:
            - Path=/api/peliculas/** # Rutas de películas
          filters:
            - StripPrefix=1 # Elimina /api del path
        - id: catalogo-admin # Admin CRUD de películas
          uri: http://catalogo-backend:8081 # Puerto del servicio Catálogo
          predicates:
            - Path=/api/admin/** # Rutas admin
        - id: rating # Servicio de Rating de Películas
          uri: http://rating-service:8082 # Puerto del servicio Rating
          predicates:
            - Path=/api/ratings/** # Rutas de ratings
          filters:
            - StripPrefix=1 # Elimina /api del path
        - id: ventas-compras # Servicio de Ventas (Compras)
          uri: http://ventas-service:8083 # Puerto del servicio Ventas
          predicates:
            - Path=/api/compras/** # Rutas de compras
        - id: ventas-carrito-confirmar # Servicio de Ventas (Confirmación de compra)
          uri: http://ventas-service:8083 # Puerto del servicio Ventas
          predicates:
            - Path=/api/carrito/confirmar # Ruta de confirmación (mantiene prefijo /api)
        - id: ventas-carrito # Servicio de Ventas (Carrito)
          uri: http://ventas-service:8083 # Puerto del servicio Ventas
          predicates:
            - Path=/api/carrito/** # Rutas de carrito
          filters:
            - StripPrefix=1 # Elimina /api del path
        - id: descuentos # Nuevo servicio de Cupones/Descuentos
          uri: http://descuentos-service:8085 # puerto de descuentos
          predicates:
            - Path=/api/descuentos/** # Rutas de películas
          filters:
            - StripPrefix=1 
        - id: keycloak # Servicio de autenticación Keycloak
          uri: http://localhost:9090 # Puerto de Keycloak
          predicates:
            - Path=/auth/**,/realms/** # Rutas de Keycloak
          filters:
            - RewritePath=/auth/(?<segment>.*), /$\{segment} # Reescribe /auth/* a /*

# Deshabilita Eureka por defecto
eureka:
  client:
    enabled: false # No registrar en Eureka
# Configuración de Actuator para diagnóstico
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true
